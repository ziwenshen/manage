# 权限管理接口文档

**基础URL**: `http://127.0.0.1:8080/api`

## 接口概述

权限管理模块提供权限的增删改查功能，支持分页查询和树形结构查询。权限系统采用 `module:menuCode:action` 的三级编码格式，用于细粒度的权限控制。

**特色功能**：
- **分页查询**: 支持按多种条件筛选的分页查询
- **权限树**: 按菜单层级组织的权限树形结构，便于管理和分配
- **编码验证**: 自动检查权限编码的唯一性
- **层级展示**: 菜单-子菜单-权限的三级层级展示

## 通用响应格式

所有接口都返回统一的JSON格式：

```json
{
  "success": true,
  "code": 200,
  "message": "success",
  "data": {}
}
```

### 响应字段说明

| 字段 | 类型 | 说明 |
|------|------|------|
| success | Boolean | 请求是否成功 |
| code | Integer | 响应状态码 |
| message | String | 响应消息 |
| data | Object | 响应数据 |

## 权限数据模型

### Permission 对象结构

```json
{
  "id": 1,
  "code": "menu:user:view",
  "name": "用户管理-查看",
  "module": "user",
  "menuCode": "user",
  "action": "view",
  "createdAt": "2025-09-08T10:19:49"
}
```

### 字段说明

| 字段 | 类型 | 说明 |
|------|------|------|
| id | Long | 权限ID |
| code | String | 权限编码，格式：module:menuCode:action |
| name | String | 权限名称 |
| module | String | 业务模块标识 |
| menuCode | String | 菜单编码 |
| action | String | 操作类型（view、add、edit、delete等） |
| url | String | 关联URL（可选） |
| createdAt | DateTime | 创建时间 |

## 接口列表

### 1. 分页查询权限列表

**接口地址**: `GET /permissions/perm/list`

**权限要求**: `menu:permission:view`

**请求头**:
```
Authorization: Bearer {JWT_TOKEN}
```

**查询参数**:

| 参数 | 类型 | 必填 | 默认值 | 说明 |
|------|------|------|--------|------|
| name | String | 否 | - | 权限名称模糊查询 |
| code | String | 否 | - | 权限编码模糊查询 |
| module | String | 否 | - | 业务模块标识 |
| menuCode | String | 否 | - | 菜单编码 |
| action | String | 否 | - | 操作类型 |
| page | Integer | 否 | 1 | 页码，从1开始 |
| size | Integer | 否 | 10 | 每页大小 |

**请求示例**:
```
GET /permissions/perm/list?module=user&action=view&page=1&size=10
```

**响应示例**:
```json
{
  "success": true,
  "code": 200,
  "message": "success",
  "data": {
    "list": [
      {
        "id": 1,
        "code": "menu:user:view",
        "name": "用户管理-查看",
        "module": "user",
        "menuCode": "user",
        "action": "view",
        "url": null,
        "createdAt": "2025-09-08T10:19:49"
      },
      {
        "id": 2,
        "code": "menu:user:add",
        "name": "用户管理-新增",
        "module": "user",
        "menuCode": "user",
        "action": "add",
        "url": null,
        "createdAt": "2025-09-08T10:19:49"
      }
    ],
    "total": 20,
    "page": 1,
    "size": 10,
    "totalPages": 2,
    "hasNext": true,
    "hasPrevious": false
  }
}
```

**分页响应字段说明**:

| 字段 | 类型 | 说明 |
|------|------|------|
| list | Array | 权限数据列表 |
| total | Long | 总记录数 |
| page | Integer | 当前页码 |
| size | Integer | 每页大小 |
| totalPages | Integer | 总页数 |
| hasNext | Boolean | 是否有下一页 |
| hasPrevious | Boolean | 是否有上一页 |

---

### 2. 获取权限树形结构（按菜单层级组织）

**接口地址**: `GET /permissions/perm/tree`

**权限要求**: `menu:permission:view`

**请求头**:
```
Authorization: Bearer {JWT_TOKEN}
```

**请求参数**: 无

**响应示例**:
```json
{
  "success": true,
  "code": 200,
  "message": "success",
  "data": [
    {
      "id": 1,
      "nodeType": "menu",
      "name": "系统管理",
      "code": "system",
      "module": "menu",
      "sortOrder": 1,
      "createdAt": "2025-09-11T17:04:08",
      "children": [
        {
          "id": 5,
          "nodeType": "permission",
          "name": "系统管理-查看",
          "code": "menu:system:view",
          "module": "system",
          "menuCode": "system",
          "action": "view",
          "url": null,
          "createdAt": "2025-09-11T17:23:17"
        },
        {
          "id": 2,
          "nodeType": "menu",
          "name": "用户管理",
          "code": "user",
          "module": "menu",
          "sortOrder": 1,
          "createdAt": "2025-09-11T17:18:57",
          "children": [
            {
              "id": 1,
              "nodeType": "permission",
              "name": "用户管理-查看",
              "code": "menu:user:view",
              "module": "user",
              "menuCode": "user",
              "action": "view",
              "url": null,
              "createdAt": "2025-09-08T10:19:49"
            },
            {
              "id": 2,
              "nodeType": "permission",
              "name": "用户管理-新增",
              "code": "menu:user:add",
              "module": "user",
              "menuCode": "user",
              "action": "add",
              "url": null,
              "createdAt": "2025-09-08T10:19:49"
            },
            {
              "id": 3,
              "nodeType": "permission",
              "name": "用户管理-编辑",
              "code": "menu:user:edit",
              "module": "user",
              "menuCode": "user",
              "action": "edit",
              "url": null,
              "createdAt": "2025-09-08T10:19:49"
            },
            {
              "id": 4,
              "nodeType": "permission",
              "name": "用户管理-删除",
              "code": "menu:user:delete",
              "module": "user",
              "menuCode": "user",
              "action": "delete",
              "url": null,
              "createdAt": "2025-09-08T10:19:49"
            },
            {
              "id": 20,
              "nodeType": "permission",
              "name": "用户管理-角色分配",
              "code": "menu:user:assignrole",
              "module": "user",
              "menuCode": "user",
              "action": "assign",
              "url": null,
              "createdAt": "2025-09-08T10:19:49"
            }
          ]
        }
      ]
    }
  ]
}
```

**树形节点字段说明**:

| 字段 | 类型 | 说明 |
|------|------|------|
| nodeType | String | 节点类型：menu=菜单节点，permission=权限节点 |
| children | Array | 子节点列表 |

**使用场景**:
- 权限管理界面的树形展示
- 角色分配权限时的层级选择
- 系统权限架构展示

---

### 3. 创建权限

**接口地址**: `POST /permissions/perm/create`

**权限要求**: `menu:permission:add`

**请求头**:
```
Authorization: Bearer {JWT_TOKEN}
Content-Type: application/json
```

**请求参数**:
```json
{
  "code": "menu:order:view",
  "name": "订单管理-查看",
  "module": "order",
  "menuCode": "order",
  "action": "view",
  "url": "/orders"
}
```

**参数说明**:

| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| code | String | 是 | 权限编码，格式：module:menuCode:action |
| name | String | 是 | 权限名称 |
| module | String | 是 | 业务模块标识 |
| menuCode | String | 是 | 菜单编码 |
| action | String | 是 | 操作类型 |
| url | String | 否 | 关联URL |

**响应示例**:
```json
{
  "success": true,
  "code": 200,
  "message": "权限创建成功",
  "data": null
}
```

**错误响应示例**:
```json
{
  "success": false,
  "code": 400,
  "message": "权限编码已存在：menu:order:view",
  "data": null
}
```

---

### 4. 更新权限

**接口地址**: `PUT /permissions/perm/update`

**权限要求**: `menu:permission:edit`

**请求头**:
```
Authorization: Bearer {JWT_TOKEN}
Content-Type: application/json
```

**请求参数**:
```json
{
  "id": 1,
  "code": "menu:order:view",
  "name": "订单管理-查看列表",
  "module": "order",
  "menuCode": "order",
  "action": "view",
  "url": "/orders/list"
}
```

**参数说明**:

| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| id | Long | 是 | 权限ID |
| code | String | 是 | 权限编码 |
| name | String | 是 | 权限名称 |
| module | String | 是 | 业务模块标识 |
| menuCode | String | 是 | 菜单编码 |
| action | String | 是 | 操作类型 |
| url | String | 否 | 关联URL |

**响应示例**:
```json
{
  "success": true,
  "code": 200,
  "message": "权限更新成功",
  "data": null
}
```

**错误响应示例**:
```json
{
  "success": false,
  "code": 404,
  "message": "权限不存在",
  "data": null
}
```

---

### 5. 删除权限

**接口地址**: `DELETE /permissions/perm/delete/{id}`

**权限要求**: `menu:permission:delete`

**请求头**:
```
Authorization: Bearer {JWT_TOKEN}
```

**路径参数**:

| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| id | Long | 是 | 权限ID |

**请求示例**:
```
DELETE /permissions/perm/delete/1
```

**响应示例**:
```json
{
  "success": true,
  "code": 200,
  "message": "权限删除成功",
  "data": null
}
```

**错误响应示例**:
```json
{
  "success": false,
  "code": 404,
  "message": "权限不存在",
  "data": null
}
```

**注意事项**:
- 删除权限会自动清理相关的角色权限关联
- 删除操作会清理相关的权限缓存
- 建议在删除前确认该权限没有被重要角色使用

---

### 6. 获取菜单权限树（用于角色分配权限）

**接口地址**: `GET /permissions/perm/menu-tree`

**权限要求**: `menu:permission:view`

**请求头**:
```
Authorization: Bearer {JWT_TOKEN}
```

**请求参数**: 无

**响应示例**:
```json
{
  "success": true,
  "code": 200,
  "message": "success",
  "data": [
    {
      "id": 1,
      "menuCode": "system",
      "name": "系统管理",
      "module": "menu",
      "nodeType": 1,
      "sortOrder": 1,
      "createdAt": "2025-09-11T17:04:08",
      "permissions": [
        {
          "id": 5,
          "code": "menu:system:view",
          "name": "系统管理-查看",
          "module": "system",
          "menuCode": "system",
          "action": "view"
        }
      ],
      "children": [
        {
          "id": 2,
          "menuCode": "user",
          "name": "用户管理",
          "module": "menu",
          "nodeType": 2,
          "sortOrder": 1,
          "createdAt": "2025-09-11T17:18:57",
          "permissions": [
            {
              "id": 1,
              "code": "menu:user:view",
              "name": "用户管理-查看",
              "module": "user",
              "menuCode": "user",
              "action": "view"
            },
            {
              "id": 2,
              "code": "menu:user:add",
              "name": "用户管理-新增",
              "module": "user",
              "menuCode": "user",
              "action": "add"
            }
          ],
          "children": []
        }
      ]
    }
  ]
}
```

**使用场景**:
- 角色分配权限时的选择界面
- 权限管理的层级展示
- 系统权限结构预览

---

## 错误码说明

| HTTP状态码 | 响应码 | 说明 | 示例场景 |
|-----------|--------|------|----------|
| 200 | 200 | 请求成功 | 正常的API调用 |
| 400 | 400 | 请求参数错误 | 缺少必填参数、参数格式错误、权限编码重复 |
| 401 | 401 | 未认证 | JWT Token无效或过期 |
| 403 | 500 | 权限不足 | 用户没有相应的操作权限 |
| 404 | 404 | 资源不存在 | 权限ID不存在 |
| 500 | 500 | 服务器内部错误 | 数据库连接失败、系统异常 |

### 常见错误响应示例

**参数错误** (HTTP 400):
```json
{
  "success": false,
  "code": 400,
  "message": "权限编码不能为空",
  "data": null
}
```

**权限编码重复** (HTTP 400):
```json
{
  "success": false,
  "code": 400,
  "message": "权限编码已存在：menu:user:view",
  "data": null
}
```

**权限不足** (HTTP 403):
```json
{
  "success": false,
  "code": 500,
  "message": "权限不足，无法执行此操作",
  "data": null
}
```

**权限不存在** (HTTP 404):
```json
{
  "success": false,
  "code": 404,
  "message": "权限不存在",
  "data": null
}
```

## 权限说明

权限管理接口需要以下权限：

| 权限码 | 说明 |
|--------|------|
| menu:permission:view | 查看权限信息 |
| menu:permission:add | 创建权限 |
| menu:permission:edit | 编辑权限 |
| menu:permission:delete | 删除权限 |

## 业务规则

### 权限编码规范

1. **格式要求**: 必须采用 `module:menuCode:action` 的三级格式
2. **唯一性**: 权限编码在系统中必须唯一
3. **命名规范**:
   - module: 业务模块标识，如 user、role、menu、permission
   - menuCode: 菜单编码，与菜单表中的menu_code对应
   - action: 操作类型，如 view、add、edit、delete、assign

### 权限编码示例

```
menu:system:view          # 系统管理-查看权限
menu:user:view            # 用户管理-查看权限
menu:user:add             # 用户管理-新增权限
menu:user:edit            # 用户管理-编辑权限
menu:user:delete          # 用户管理-删除权限
menu:user:assignrole      # 用户管理-角色分配权限
menu:role:view            # 角色管理-查看权限
menu:role:add             # 角色管理-新增权限
menu:role:edit            # 角色管理-编辑权限
menu:role:delete          # 角色管理-删除权限
menu:role:assignpermission # 角色管理-权限分配权限
menu:menu:view            # 菜单管理-查看权限
menu:menu:add             # 菜单管理-新增权限
menu:menu:edit            # 菜单管理-编辑权限
menu:menu:delete          # 菜单管理-删除权限
menu:permission:view      # 权限管理-查看权限
menu:permission:add       # 权限管理-新增权限
menu:permission:edit      # 权限管理-编辑权限
menu:permission:delete    # 权限管理-删除权限
```

### 权限层级关系

1. **菜单与权限关联**: 权限通过menuCode字段与菜单关联
2. **模块化管理**: 按业务模块组织权限，便于管理和分配
3. **操作细分**: 每个菜单可以有多个操作权限，实现细粒度控制

## 使用示例

### 完整的权限管理流程

```bash
# 1. 分页查询权限列表
curl -X GET "http://127.0.0.1:8080/api/permissions/perm/list?page=1&size=10" \
  -H "Authorization: Bearer {your_token}"

# 2. 按条件查询权限
curl -X GET "http://127.0.0.1:8080/api/permissions/perm/list?module=user&action=view" \
  -H "Authorization: Bearer {your_token}"

# 3. 获取权限树结构
curl -X GET "http://127.0.0.1:8080/api/permissions/perm/tree" \
  -H "Authorization: Bearer {your_token}"

# 4. 创建新权限
curl -X POST "http://127.0.0.1:8080/api/permissions/perm/create" \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer {your_token}" \
  -d '{
    "code": "menu:order:view",
    "name": "订单管理-查看",
    "module": "order",
    "menuCode": "order",
    "action": "view",
    "url": "/orders"
  }'

# 5. 更新权限信息
curl -X PUT "http://127.0.0.1:8080/api/permissions/perm/update" \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer {your_token}" \
  -d '{
    "id": 1,
    "code": "menu:order:view",
    "name": "订单管理-查看列表",
    "module": "order",
    "menuCode": "order",
    "action": "view",
    "url": "/orders/list"
  }'

# 6. 删除权限
curl -X DELETE "http://127.0.0.1:8080/api/permissions/perm/delete/1" \
  -H "Authorization: Bearer {your_token}"

# 7. 获取菜单权限树（用于角色分配）
curl -X GET "http://127.0.0.1:8080/api/permissions/perm/menu-tree" \
  -H "Authorization: Bearer {your_token}"
```

### JavaScript 示例

```javascript
// 基础配置
const API_BASE = 'http://127.0.0.1:8080/api';

// 获取JWT Token
function getToken() {
  return localStorage.getItem('jwt_token') || 'your_jwt_token_here';
}

// 通用请求函数
async function apiRequest(url, options = {}) {
  const response = await fetch(`${API_BASE}${url}`, {
    headers: {
      'Content-Type': 'application/json',
      'Authorization': `Bearer ${getToken()}`,
      ...options.headers
    },
    ...options
  });
  return response.json();
}

// 分页查询权限列表
async function getPermissionList(params = {}) {
  const queryString = new URLSearchParams(params).toString();
  const url = `/permissions/perm/list${queryString ? '?' + queryString : ''}`;
  return await apiRequest(url);
}

// 获取权限树
async function getPermissionTree() {
  return await apiRequest('/permissions/perm/tree');
}

// 创建权限
async function createPermission(permissionData) {
  return await apiRequest('/permissions/perm/create', {
    method: 'POST',
    body: JSON.stringify(permissionData)
  });
}

// 更新权限
async function updatePermission(permissionData) {
  return await apiRequest('/permissions/perm/update', {
    method: 'PUT',
    body: JSON.stringify(permissionData)
  });
}

// 删除权限
async function deletePermission(permissionId) {
  return await apiRequest(`/permissions/perm/delete/${permissionId}`, {
    method: 'DELETE'
  });
}

// 获取菜单权限树
async function getMenuPermissionTree() {
  return await apiRequest('/permissions/perm/menu-tree');
}

// 使用示例
async function example() {
  try {
    // 查询权限列表
    const permissionList = await getPermissionList({
      module: 'user',
      action: 'view',
      page: 1,
      size: 10
    });
    console.log('权限列表:', permissionList);

    // 获取权限树
    const permissionTree = await getPermissionTree();
    console.log('权限树:', permissionTree);

    // 创建权限
    const createResult = await createPermission({
      code: 'menu:order:view',
      name: '订单管理-查看',
      module: 'order',
      menuCode: 'order',
      action: 'view',
      url: '/orders'
    });
    console.log('创建结果:', createResult);

  } catch (error) {
    console.error('操作失败:', error);
  }
}
```

### 前端集成示例

#### Vue.js 权限管理组件

```vue
<template>
  <div class="permission-management">
    <!-- 权限列表 -->
    <div class="permission-list">
      <el-table :data="permissionList" border>
        <el-table-column prop="code" label="权限编码" width="200"/>
        <el-table-column prop="name" label="权限名称" width="150"/>
        <el-table-column prop="module" label="模块" width="100"/>
        <el-table-column prop="menuCode" label="菜单编码" width="120"/>
        <el-table-column prop="action" label="操作" width="100"/>
        <el-table-column label="操作" width="200">
          <template #default="scope">
            <el-button size="small" @click="editPermission(scope.row)">编辑</el-button>
            <el-button size="small" type="danger" @click="deletePermission(scope.row.id)">删除</el-button>
          </template>
        </el-table-column>
      </el-table>

      <!-- 分页 -->
      <el-pagination
        v-model:current-page="pagination.page"
        v-model:page-size="pagination.size"
        :total="pagination.total"
        @current-change="loadPermissionList"
        @size-change="loadPermissionList"
      />
    </div>

    <!-- 权限树 -->
    <div class="permission-tree">
      <el-tree
        :data="permissionTree"
        :props="treeProps"
        node-key="id"
        show-checkbox
        default-expand-all
      />
    </div>
  </div>
</template>

<script setup>
import { ref, onMounted } from 'vue'

const permissionList = ref([])
const permissionTree = ref([])
const pagination = ref({
  page: 1,
  size: 10,
  total: 0
})

const treeProps = {
  children: 'children',
  label: 'name'
}

// 加载权限列表
async function loadPermissionList() {
  try {
    const response = await getPermissionList({
      page: pagination.value.page,
      size: pagination.value.size
    })
    if (response.success) {
      permissionList.value = response.data.list
      pagination.value.total = response.data.total
    }
  } catch (error) {
    console.error('加载权限列表失败:', error)
  }
}

// 加载权限树
async function loadPermissionTree() {
  try {
    const response = await getPermissionTree()
    if (response.success) {
      permissionTree.value = response.data
    }
  } catch (error) {
    console.error('加载权限树失败:', error)
  }
}

// 编辑权限
function editPermission(permission) {
  // 打开编辑对话框
  console.log('编辑权限:', permission)
}

// 删除权限
async function deletePermission(permissionId) {
  try {
    const response = await deletePermission(permissionId)
    if (response.success) {
      ElMessage.success('删除成功')
      loadPermissionList()
    }
  } catch (error) {
    console.error('删除权限失败:', error)
  }
}

onMounted(() => {
  loadPermissionList()
  loadPermissionTree()
})
</script>
```

#### React 权限管理组件

```jsx
import React, { useState, useEffect } from 'react';
import { Table, Tree, Button, Pagination, message } from 'antd';

const PermissionManagement = () => {
  const [permissionList, setPermissionList] = useState([]);
  const [permissionTree, setPermissionTree] = useState([]);
  const [pagination, setPagination] = useState({
    current: 1,
    pageSize: 10,
    total: 0
  });

  // 表格列定义
  const columns = [
    { title: '权限编码', dataIndex: 'code', key: 'code', width: 200 },
    { title: '权限名称', dataIndex: 'name', key: 'name', width: 150 },
    { title: '模块', dataIndex: 'module', key: 'module', width: 100 },
    { title: '菜单编码', dataIndex: 'menuCode', key: 'menuCode', width: 120 },
    { title: '操作', dataIndex: 'action', key: 'action', width: 100 },
    {
      title: '操作',
      key: 'actions',
      width: 200,
      render: (_, record) => (
        <>
          <Button size="small" onClick={() => editPermission(record)}>编辑</Button>
          <Button size="small" danger onClick={() => handleDeletePermission(record.id)}>删除</Button>
        </>
      )
    }
  ];

  // 加载权限列表
  const loadPermissionList = async (page = 1, size = 10) => {
    try {
      const response = await getPermissionList({ page, size });
      if (response.success) {
        setPermissionList(response.data.list);
        setPagination(prev => ({
          ...prev,
          current: page,
          pageSize: size,
          total: response.data.total
        }));
      }
    } catch (error) {
      console.error('加载权限列表失败:', error);
    }
  };

  // 加载权限树
  const loadPermissionTree = async () => {
    try {
      const response = await getPermissionTree();
      if (response.success) {
        setPermissionTree(response.data);
      }
    } catch (error) {
      console.error('加载权限树失败:', error);
    }
  };

  // 编辑权限
  const editPermission = (permission) => {
    console.log('编辑权限:', permission);
  };

  // 删除权限
  const handleDeletePermission = async (permissionId) => {
    try {
      const response = await deletePermission(permissionId);
      if (response.success) {
        message.success('删除成功');
        loadPermissionList(pagination.current, pagination.pageSize);
      }
    } catch (error) {
      console.error('删除权限失败:', error);
    }
  };

  // 分页变化处理
  const handlePaginationChange = (page, pageSize) => {
    loadPermissionList(page, pageSize);
  };

  useEffect(() => {
    loadPermissionList();
    loadPermissionTree();
  }, []);

  return (
    <div className="permission-management">
      <div className="permission-list">
        <Table
          columns={columns}
          dataSource={permissionList}
          rowKey="id"
          pagination={false}
          bordered
        />
        <Pagination
          current={pagination.current}
          pageSize={pagination.pageSize}
          total={pagination.total}
          onChange={handlePaginationChange}
          showSizeChanger
          showQuickJumper
          showTotal={(total, range) => `第 ${range[0]}-${range[1]} 条/共 ${total} 条`}
        />
      </div>

      <div className="permission-tree">
        <Tree
          treeData={permissionTree}
          checkable
          defaultExpandAll
          fieldNames={{ title: 'name', key: 'id', children: 'children' }}
        />
      </div>
    </div>
  );
};

export default PermissionManagement;
```

## 总结

权限管理接口提供了完整的CRUD功能，支持：

1. **分页查询**: 支持多条件筛选的分页查询
2. **树形结构**: 按菜单层级组织的权限树，便于管理和分配
3. **权限验证**: 完整的权限控制和编码唯一性验证
4. **错误处理**: 详细的错误码和错误信息
5. **前端集成**: 提供了Vue.js和React的集成示例

### 核心特性

- **层级展示**: 菜单-子菜单-权限的三级层级结构
- **编码规范**: module:menuCode:action的标准化编码格式
- **权限控制**: 基于JWT的身份认证和权限验证
- **缓存管理**: 自动处理权限相关的缓存更新
- **关联清理**: 删除权限时自动清理相关的角色权限关联

这套权限管理接口可以满足企业级应用的权限管理需求，支持细粒度的权限控制和灵活的权限分配。

---
