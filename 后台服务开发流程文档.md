# 后台服务开发流程文档

本文件为后台服务开发的高层流程目录（TOC），用于团队协作、代码规范、发布与运维对齐。后续将根据此目录补齐每一节的具体操作步骤、模板与示例。

## 目录

1. 项目概览
   1.1 项目结构约定
      1.1.1 目的
         - 统一项目包与目录结构，便于团队协作、Code Review 与自动化工具识别。

      1.1.2 顶层目录约定
         - `src/main/java`：应用源码，包名以 `com.<company>.<project>` 为根（示例：`com.server.manage`）。
         - `src/main/resources`：资源文件（配置、mapper、templates、static、i18n、db/migration 等）。
         - `src/test/java`：测试代码，与源码包结构保持一致。
         - `scripts/`：项目相关脚本（启动、数据库迁移、构建辅助脚本）。
         - `logs/`：运行时日志输出目录（非源码，建议在 `.gitignore` 中忽略）。
         - `pom.xml` 或 `build.gradle`：构建与依赖声明（Maven/Gradle）。

      1.1.3 Java 包（package）分层约定
         - `controller`：处理 HTTP 请求与路由层（REST/页面控制器）。
         - `service`：业务逻辑层，建议接口与实现分离（`XxxService` + `impl` 包或 `XxxServiceImpl`）。
         - `repository` / `mapper`：数据访问层（Spring Data JPA 仓库或 MyBatis mapper）。
         - `model` / `entity`：JPA 实体或领域模型类。
         - `dto`：控制器与服务间的数据传输对象（避免直接暴露 Entity）。
         - `config`：Spring 配置类、Bean 定义、跨域与 Web 配置等。
         - `security`：认证/授权相关代码（SecurityConfig、JWT 工具、权限校验等）。
         - `exception`：自定义异常类与全局异常处理器（如 `GlobalExceptionHandler`）。
         - `common`：通用共享组件（ApiResponse、常量、基础类型）。
         - `util`：工具类集合（静态辅助函数、日期、JSON、加密等）。
         - `scheduler`：定时任务相关类（`@Scheduled`）。
         - `client`：对外服务调用（Feign 接口、RestTemplate 封装）。

      1.1.4 资源文件约定
         - `application.yml` / `application.properties`：默认配置文件，按环境区分（application-dev.yml 等）。
         - `config/`：额外配置文件（第三方库配置、邮件、消息队列等）。
         - `db/migration/`：数据库迁移脚本（Flyway 或 Liquibase）。
         - `mapper/`：MyBatis XML mapper 文件（如使用 MyBatis）。
         - `i18n/`：国际化资源（messages.properties）。
         - `static/`、`templates/`：静态资源与模板文件。

      1.1.5 命名规范与约束（建议）
         - 包名：全部小写，使用公司与项目标识（`com.server.manage`）。
         - 类名：UpperCamelCase，接口以 Service/Repository 等结尾（例如 `UserService`、`OrderRepository`）。
         - 方法名：lowerCamelCase，清晰表意。
         - DTO 命名：以场景或方向命名（`OrderCreateRequest`、`OrderResponse`）。
         - 常量：全部大写、下划线分隔（`MAX_RETRY_COUNT`）。

      1.1.6 代码组织最佳实践
         - 每个模块（如 user、order）内部可按 `controller/service/repository/dto` 子包划分，保持高内聚、低耦合。
         - 接口优先、实现分离，便于单元测试与 Mock。
         - 避免在 Controller 中写复杂业务逻辑；Controller 只做参数校验、调用 Service、组装响应。

      1.1.7 示例目录树（简短）
         - src/main/java/com/server/manage
            - controller/
            - service/
            - repository/
            - model/
            - dto/
            - config/
            - security/
            - exception/
            - common/
            - util/

      1.1.8 版本控制与仓库约定
         - `.gitignore`：忽略 `target/`、`logs/`、IDE 配置文件、本地密钥文件等。
         - README：项目根需包含简短启动说明与本地运行步骤。
         - 提交信息：建议遵循团队约定（如 Conventional Commits）。

      1.1.9 说明和例外
         - 若项目采用微服务拆分，每个服务遵循相同约定，公共组件提取到共享库或 `client` 包。
         - 对于快速原型或 PoC，可放宽部分约定，但上线前应调整到规范。
   1.2 依赖与构建工具
      1.2.1 构建工具选择
         - 推荐使用 Maven（本仓库含 `pom.xml`）或 Gradle 二选一。Maven 适合传统企业项目与稳定构建；Gradle 适合需要更灵活脚本与增量构建的场景。
         - 明确团队标准并在组织内统一，以避免多种构建工具并存导致 CI 配置复杂。

      1.2.2 版本与语义化依赖策略
         - JDK 版本：平台统一（示例：JDK 11 或 JDK 17），在 `README` 与 CI 中声明并强制检查。
         - 依赖版本：优先使用已发布的稳定版本（非 SNAPSHOT），关键库采用已知兼容的固定版本。
         - 采用语义化版本控制（SemVer）并在发布说明中记录变更。

      1.2.3 常用 Maven/Gradle 插件与配置要点
         - 编译/打包：`maven-compiler-plugin`、`spring-boot-maven-plugin`（或 Gradle 等价插件）。
         - 质量检查：`maven-surefire-plugin`（测试）、`jacoco-maven-plugin`（覆盖率）、`maven-checkstyle-plugin`（代码风格）、`spotbugs-maven-plugin`（静态检查）。
         - 安全扫描：集成 OWASP Dependency-Check 或 Snyk（CI 中自动扫描依赖漏洞）。
         - Docker 构建：若使用 Docker 镜像，建议在 CI 中使用官方 JIB 或 Dockerfile 构建并推送制品仓库。

      1.2.4 本地构建与常用命令（示例，Maven）
         - 编译并运行单元测试：
          - mvn clean package -DskipTests=false
         - 只编译跳过测试：
          - mvn clean package -DskipTests
         - 运行集成测试（若有 profile 支持）：
          - mvn -P integration-test verify
         - 生成覆盖率报告（JaCoCo）：
          - mvn test jacoco:report

      1.2.5 依赖管理与制品库
         - 私有制品仓库：使用 Nexus/Artifactory 存放内部库与第三方镜像，CI 推送构建产物到制品库。
         - 依赖白名单/镜像代理：在企业网络环境下使用内部镜像代理以提高稳定性并满足合规要求。

      1.2.6 CI 中的构建注意点
         - 在 CI 中固定 JDK 与构建镜像版本，避免“本地可跑、CI 失败”的问题。
         - 在 CI pipeline 中把编译、单元测试、静态检查、安全扫描、打包推制品仓库作为必经阶段。
         - 对于多模块项目，使用并行模块构建与缓存依赖加速构建时间。

      1.2.7 依赖安全与许可证合规
         - 安装依赖漏洞扫描（Dependency-Check、Snyk、OSS Index），在 CI 中对高危漏洞阻断发布或发出告警。
         - 维护依赖许可证清单，避免引入与公司合规政策冲突的许可证（GPL/AGPL 等，视公司策略而定）。

      1.2.8 本地开发环境建议
         - 使用与 CI 相同的 JDK 版本与构建命令。
         - 建议设置 Maven/Gradle 的本地镜像配置（镜像仓库地址）加速依赖下载。

      1.2.9 版本锁定与升级策略
         - 主动升级策略：定期（例如季度）计划依赖升级窗口，并在开发/测试环境验证后在生产环境升级。
         - 紧急补丁：对高危安全漏洞采用单独补丁流程并在 CI 中快速回归测试。

      1.2.10 说明
         - 本仓库含 `pom.xml` 和 `mvnw`/`mvnw.cmd`，表明当前使用 Maven 并提供 Wrapper 以保证构建版本一致性。
   1.3 运行与环境要求
      1.3.1 平台与 JDK 要求
         - 统一 JDK 版本（示例：JDK 11 或 JDK 17）。在 `README`、CI 配置与运维文档中明确并强制校验。
         - 建议使用 Amazon Corretto、OpenJDK 或 Oracle JDK 的长期支持版本（LTS）。

      1.3.2 JVM 配置建议
         - 默认 Xms/Xmx：根据服务内存需求设定（例如 512m/1024m 或 1g/2g），并在容器环境中使用容器限制为准。
         - GC 策略：推荐使用 G1/GraalVM（视 JDK 版本与性能要求），并在性能测试中确定具体参数。
         - 建议开启 JVM 远程监控/采集端点（如 JMX）并在生产环境使用只读或受限访问方式。

      1.3.3 系统资源与限制
         - CPU/内存：按服务 QPS 和业务复杂度评估实例规格，建议在部署文档中列出推荐资源配置。
         - 文件句柄：高并发场景下检查并调整操作系统文件描述符限制（ulimit -n）。
         - 网络端口：列出必须开放的端口（如 HTTP、管理端点、健康检查端口等）。

      1.3.4 环境变量与配置管理
         - 使用配置中心（Spring Cloud Config、Consul、Vault）或环境变量管理不同环境配置，避免在代码中硬编码敏感信息。
         - 对 secrets 使用专门的安全存储（HashiCorp Vault、云厂商 Secrets Manager），CI/CD 不应在明文日志中输出 secrets。
         - 配置优先级示例：环境变量 > 配置中心 > application-{profile}.yml > application.yml。

      1.3.5 容器化与运行时（可选/推荐）
         - 建议提供 Dockerfile 或使用 Jib 构建镜像，镜像中只包含运行时所需最小依赖。
         - 容器运行时参数：以内存限制、CPU 限制、探针（liveness/readness）和重启策略为准。
         - Kubernetes：建议在 Deployment 中设置资源请求/限制（resources.requests/limits）、探针（readinessProbe/livenessProbe）和滚动更新策略。

      1.3.6 日志与持久化
         - 日志建议输出到控制台（stdout/stderr），由容器或宿主机统一采集到 ELK/EFK 或云日志服务。
         - 不要在容器内持久化业务数据或日志文件，使用外部存储或中心化日志方案。

      1.3.7 健康检查与启动/关闭顺序
         - 提供 `/actuator/health` 或自定义健康检查接口，确保包含依赖项（数据库、缓存、外部服务）的检查项。
         - 支持优雅下线：响应 SIGTERM 后先关闭流量（K8s preStop / deregister from service registry），再等待正在进行请求完成后关闭。

      1.3.8 网络、安全与访问控制
         - 使用 TLS（HTTPS）对外提供 API，内部服务间通信建议启用 mTLS 或使用服务网格（Istio/Linkerd）增强安全。
         - 对管理与诊断接口（如 actuator）进行访问控制，默认仅允许内网或经过认证的访问。

      1.3.9 监控与采集指标
         - 集成 Prometheus 指标（Micrometer）并暴露 `/actuator/prometheus` 或自定义指标端点。
         - 在文档中列出需要采集的关键指标（请求速率、错误率、延迟分位、GC/内存、线程池使用率、数据库连接池使用率）。

      1.3.10 环境分级与差异说明
         - 环境分级：dev（开发）、staging/qa（联调）、pre-prod（预发布）、prod（生产）。
         - 每个环境应有独立配置、数据集与访问控制策略，且生产环境需更严格的监控、审计与回滚流程。

      1.3.11 运行兼容性与测试矩阵
         - 定义兼容性矩阵（JDK 版本、数据库版本、操作系统、Redis/Message Broker 版本），并在变更依赖前验证兼容性。

      1.3.12 说明
         - 以上为通用建议，实际数值（内存/CPU、GC 参数）需通过负载测试（Load/Stress 测试）后确定。

2. 开发准备
   2.1 代码仓库与分支策略
   2.2 本地开发环境搭建
   2.3 规范与编码风格
   2.4 本地数据库与测试数据准备

3. 需求与设计
   3.1 需求接收与评估
   3.2 接口设计与契约
   3.3 数据库设计与迁移策略
   3.4 权限与安全设计（含菜单/按钮级权限）

4. 编码实践
   4.1 控制器层（Controller）规范
   4.2 服务层（Service）规范
   4.3 仓库层（Repository/Mapper）规范
   4.4 DTO/Model/Mapper 使用指南
   4.5 异常与日志处理规范
   4.6 测试策略（单元/集成/端到端）
   4.7 API 文档与注释规范

5. 权限管理与鉴权
   5.1 权限模型与字符串约定
   5.2 数据库表结构与示例 DDL
   5.3 权限缓存策略（Redis）
   5.4 统一 action 接口与自定义菜单鉴权
   5.5 后端校验方法（注解/AOP/Spring Security）

6. 构建与持续集成
   6.1 构建流程（Maven/Gradle）
   6.2 单元测试与覆盖率要求
   6.3 持续集成（CI）配置要点
   6.4 制品管理与依赖版本控制

7. 部署与发布
   7.1 环境分级（dev/test/prod）
   7.2 配置管理与 secrets 存储
   7.3 数据库迁移与回滚策略
   7.4 蓝绿/滚动发布实践
   7.5 发布验收与回滚流程

8. 运行与监控
   8.1 日志策略与集中化（ELK/EFK）
   8.2 性能监控与报警（Prometheus/Grafana）
   8.3 健康检查与熔断限流
   8.4 灰度与流量控制

9. 安全与合规
   9.1 鉴权/授权策略
   9.2 敏感信息与审计日志
   9.3 常见安全防护措施

10. 运维与故障处理
    10.1 常见故障处理流程
    10.2 回溯与根因分析（RCA）模版
    10.3 incident 通信与SLA

11. 文档与知识库
    11.1 API 文档生成（Swagger/OpenAPI）
    11.2 设计文档与变更记录
    11.3 常见问题与解决方案

12. 附录
    12.1 常用命令与脚本
    12.2 示例配置文件（application.yml、logback）
    12.3 推荐依赖与插件


---

附：本目录部分章节内容参考自仓库内文档：
- `后台管理文档.md`（项目结构、目录说明、建议初始文件）
- `后端服务菜单按钮级权限管理.md`（权限模型、DDL、接口契约、鉴权策略）
