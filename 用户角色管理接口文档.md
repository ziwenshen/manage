# 用户角色管理接口文档

**基础URL**: `http://127.0.0.1:8080/api`

## 接口概述

用户角色管理模块提供用户角色的查询和分配功能。通过这些接口，管理员可以查看用户当前拥有的角色，以及为用户分配新的角色。

## 通用响应格式

所有接口都返回统一的JSON格式：

```json
{
  "success": true,
  "code": 200,
  "message": "success",
  "data": {}
}
```

### 响应字段说明

| 字段 | 类型 | 说明 |
|------|------|------|
| success | Boolean | 请求是否成功 |
| code | Integer | 响应状态码 |
| message | String | 响应消息 |
| data | Object | 响应数据 |

## 接口列表

### 1. 获取用户角色列表

**接口地址**: `GET /users/{userId}/roles`

**权限要求**: `menu:user:view`

**请求头**:
```
Authorization: Bearer {JWT_TOKEN}
```

**路径参数**:

| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| userId | Long | 是 | 用户ID |

**请求示例**:
```
GET /users/1/roles
```

**响应示例**:
```json
{
  "success": true,
  "code": 200,
  "message": "success",
  "data": [1, 2, 3]
}
```

**响应字段说明**:

| 字段 | 类型 | 说明 |
|------|------|------|
| data | Array | 用户拥有的角色ID列表 |

**使用场景**:
- 查看用户当前拥有的角色
- 编辑用户角色时的数据回显
- 用户权限审计

---

### 2. 分配用户角色

**接口地址**: `POST /users/{userId}/roles`

**权限要求**: `menu:user:assignrole`

**请求头**:
```
Authorization: Bearer {JWT_TOKEN}
Content-Type: application/json
```

**路径参数**:

| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| userId | Long | 是 | 用户ID |

**请求参数**:
```json
{
  "roleIds": [1, 2, 3]
}
```

**参数说明**:

| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| roleIds | Array | 是 | 角色ID列表，可以为空数组（表示清空所有角色） |

**请求示例**:
```json
{
  "roleIds": [1, 2, 3]
}
```

**响应示例**:
```json
{
  "success": true,
  "code": 200,
  "message": "用户角色分配成功",
  "data": null
}
```

**功能说明**:
- 会先清空用户原有的所有角色关联
- 然后重新分配请求中指定的角色
- 分配完成后会自动刷新用户的权限缓存
- 如果roleIds为空数组，则清空用户的所有角色

**注意事项**:
- 角色分配是覆盖式的，不是追加式的
- 分配角色后用户权限会立即生效
- 需要确保角色ID存在，否则可能导致数据不一致

---

## 错误码说明

| HTTP状态码 | 响应码 | 说明 | 示例场景 |
|-----------|--------|------|----------|
| 200 | 200 | 请求成功 | 正常的API调用 |
| 400 | 400 | 请求参数错误 | 用户ID为空、角色ID列表格式错误 |
| 401 | 401 | 未认证 | JWT Token无效或过期 |
| 403 | 500 | 权限不足 | 用户没有相应的操作权限 |
| 404 | 404 | 资源不存在 | 用户ID不存在 |
| 500 | 500 | 服务器内部错误 | 数据库连接失败、系统异常 |

### 常见错误响应示例

**用户不存在** (HTTP 404):
```json
{
  "success": false,
  "code": 404,
  "message": "用户不存在",
  "data": null
}
```

**参数错误** (HTTP 400):
```json
{
  "success": false,
  "code": 400,
  "message": "用户ID不能为空",
  "data": null
}
```

**权限不足** (HTTP 403):
```json
{
  "success": false,
  "code": 500,
  "message": "权限不足，无法执行此操作",
  "data": null
}
```

## 权限说明

用户角色管理接口需要以下权限：

| 权限码 | 说明 |
|--------|------|
| menu:user:view | 查看用户角色信息 |
| menu:user:assignrole | 分配用户角色 |

## 使用示例

### 完整的用户角色管理流程

```bash
# 1. 获取用户当前角色
curl -X GET "http://127.0.0.1:8080/api/users/1/roles" \
  -H "Authorization: Bearer {your_token}"

# 2. 分配用户角色
curl -X POST "http://127.0.0.1:8080/api/users/1/roles" \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer {your_token}" \
  -d '{
    "roleIds": [1, 2, 3]
  }'

# 3. 清空用户所有角色
curl -X POST "http://127.0.0.1:8080/api/users/1/roles" \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer {your_token}" \
  -d '{
    "roleIds": []
  }'
```

### JavaScript 示例

```javascript
// 基础配置
const API_BASE = 'http://127.0.0.1:8080/api';

// 获取JWT Token
function getToken() {
  return localStorage.getItem('jwt_token') || 'your_jwt_token_here';
}

// 通用请求函数
async function apiRequest(url, options = {}) {
  const response = await fetch(`${API_BASE}${url}`, {
    headers: {
      'Content-Type': 'application/json',
      'Authorization': `Bearer ${getToken()}`,
      ...options.headers
    },
    ...options
  });
  return response.json();
}

// 获取用户角色
async function getUserRoles(userId) {
  return await apiRequest(`/users/${userId}/roles`);
}

// 分配用户角色
async function assignUserRoles(userId, roleIds) {
  return await apiRequest(`/users/${userId}/roles`, {
    method: 'POST',
    body: JSON.stringify({ roleIds })
  });
}

// 使用示例
async function example() {
  try {
    // 获取用户当前角色
    const currentRoles = await getUserRoles(1);
    console.log('用户当前角色:', currentRoles.data);

    // 分配新角色
    const assignResult = await assignUserRoles(1, [1, 2, 3]);
    console.log('角色分配结果:', assignResult);

    // 再次获取角色确认
    const updatedRoles = await getUserRoles(1);
    console.log('更新后的角色:', updatedRoles.data);

  } catch (error) {
    console.error('操作失败:', error);
  }
}

// 用户角色管理组件示例
class UserRoleManager {
  constructor() {
    this.userId = null;
    this.currentRoles = [];
    this.availableRoles = [];
  }

  // 初始化用户角色管理
  async init(userId) {
    this.userId = userId;
    await this.loadCurrentRoles();
    await this.loadAvailableRoles();
    this.renderRoleSelector();
  }

  // 加载用户当前角色
  async loadCurrentRoles() {
    try {
      const result = await getUserRoles(this.userId);
      if (result.success) {
        this.currentRoles = result.data;
      } else {
        console.error('加载用户角色失败:', result.message);
      }
    } catch (error) {
      console.error('加载用户角色异常:', error);
    }
  }

  // 加载所有可用角色
  async loadAvailableRoles() {
    try {
      // 假设有获取所有角色的接口
      const result = await apiRequest('/permissions/roles/list');
      if (result.success) {
        this.availableRoles = result.data.list || result.data;
      }
    } catch (error) {
      console.error('加载可用角色异常:', error);
    }
  }

  // 渲染角色选择器
  renderRoleSelector() {
    const container = document.getElementById('role-selector');
    let html = '<div class="role-selector">';
    
    for (const role of this.availableRoles) {
      const checked = this.currentRoles.includes(role.id) ? 'checked' : '';
      html += `
        <label class="role-item">
          <input type="checkbox" value="${role.id}" ${checked}>
          <span class="role-name">${role.name}</span>
          <span class="role-code">(${role.code})</span>
        </label>
      `;
    }
    
    html += '</div>';
    html += '<button onclick="userRoleManager.saveRoles()">保存角色</button>';
    
    container.innerHTML = html;
  }

  // 保存角色分配
  async saveRoles() {
    const checkboxes = document.querySelectorAll('#role-selector input[type="checkbox"]:checked');
    const selectedRoleIds = Array.from(checkboxes).map(cb => parseInt(cb.value));
    
    try {
      const result = await assignUserRoles(this.userId, selectedRoleIds);
      if (result.success) {
        alert('角色分配成功！');
        this.currentRoles = selectedRoleIds;
      } else {
        alert('角色分配失败：' + result.message);
      }
    } catch (error) {
      console.error('保存角色失败:', error);
      alert('保存角色失败，请重试');
    }
  }
}

// 初始化用户角色管理器
const userRoleManager = new UserRoleManager();

// 页面加载时初始化（假设用户ID为1）
document.addEventListener('DOMContentLoaded', () => {
  userRoleManager.init(1);
});
```

## 注意事项

1. **认证要求**: 所有接口都需要有效的JWT Token
2. **权限验证**: 每个接口都会验证用户是否具有相应的权限
3. **数据一致性**: 角色分配是事务性操作，确保数据一致性
4. **缓存刷新**: 角色变更会自动刷新用户权限缓存，确保权限立即生效
5. **覆盖式分配**: 角色分配是覆盖式的，会先清空原有角色再分配新角色
6. **用户存在性**: 分配角色前会检查用户是否存在
7. **操作审计**: 用户角色的变更建议记录操作日志

## 最佳实践

### 角色分配原则

1. **最小权限原则**: 只分配用户工作所需的最小角色集合
2. **角色分离**: 避免给单个用户分配过多角色
3. **定期审查**: 定期审查用户角色分配的合理性
4. **权限继承**: 通过角色继承权限，避免直接给用户分配权限

### 前端集成建议

1. **角色选择器**: 使用复选框或多选下拉框展示可选角色
2. **当前角色显示**: 清晰显示用户当前拥有的角色
3. **批量操作**: 支持批量选择和取消选择角色
4. **确认机制**: 重要的角色变更操作需要用户确认

---

## 更新日志

### v1.0.0 (2025-09-14)
- 初始版本发布
- 支持用户角色的查询和分配功能
- 集成权限验证系统
- 支持权限缓存自动刷新
